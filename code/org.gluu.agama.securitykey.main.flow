Flow org.gluu.agama.securitykey.main
     Basepath ""
Log "@debug Main flow started!"
loginForm = { success: true }
casaApi = Call org.gluu.agama.securitykey.CasaApi#new 
Repeat 3 times max
     creds = RRF "main.ftlh" loginForm
     userData = Call org.gluu.agama.securitykey.IdentityProcessor#accountFromUid creds.username
     Log "@debug UserData %" userData
     loginForm.username = creds.username
     When userData is not null
          inum = userData.inum
          uid = userData.uid
          mfaInfo = Call casaApi getMFAUserInfoByFido2 inum
          Log "@debug MfaInfo response: %" mfaInfo
          count = mfaInfo.count
          Log "@debug User % has % credentials enrolled" inum count
          When count is 0
               it_erxpm = {success:false, error: "Your account has no security key configured."}
               Finish it_erxpm
          withEscape = true
          Log "@trace Just logging *********************"
          fidoAuthn = Trigger org.gluu.agama.securitykey.fidoAuthn userData withEscape
          Log "@debug Response FidoAuthn % % " fidoAuthn  fidoAuthn.success
          When fidoAuthn.success is not true
               it_fqbce = {success:false, error: "Finished with error"}
               Finish it_fqbce
          Otherwise
               it_jqgwo = {success:true, data: { userId: inum, message: "Authentication sucess! "}}
               Finish it_jqgwo
     loginForm.success = false
it_nbjdo = {success:false, error: "Login attempt exceeded."}
Finish it_nbjdo