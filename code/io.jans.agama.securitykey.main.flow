Flow io.jans.agama.securitykey.main
     Basepath ""
Log "@debug Main flow started!"
loginForm = { success: true }
casaApi = Call io.jans.agamasecuritykey.CasaApi#new 
Repeat 3 times max
     creds = RRF "main.ftlh" loginForm
     userData = Call io.jans.agamasecuritykey.IdentityProcessor#accountFromUid creds.username
     loginForm.username = creds.username
     When userData is not null
          inum = userData.inum
          uid = userData.uid
          mfaInfo = Call casaApi getMFAUserInfoByFido2 inum
          count = mfaInfo.count
          Log "@debug User % has % credentials enrolled" inum count
          When count is 0
               it_ikfks = { success: false, error: "Your account has no security key configured." }
               Finish it_ikfks
          fidoAuthn = Trigger io.jans.agama.securitykey.fidoAuthn true
          Log "@debug Response FidoAuthn %" fidoAuthn
          When fidoAuthn.success is true
               Finish uid
it_wiqbh = { success: false, error: "Login attempt exceeded." }
Finish it_wiqbh